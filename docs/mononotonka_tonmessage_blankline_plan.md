# TonMessage `[blankline]` 実装計画

## 1. 目的
- TonMessage スクリプトの可読性を維持しつつ、表示上の空行を明示的に制御できるようにする。
- 既存の「改行コード = スクリプト改行」運用は維持したまま、空行行とコメント行の取り扱いを明確化する。

## 2. 適用範囲
- 実装対象: `mononotonka/TonMessage.cs`
- 文書対象: `manual/class_tonmessage.html`
- 非対象:
  - 既存タグ（`[wait]`, `[next]`, `[event]` など）の意味変更
  - TonMessage 以外のクラス改修

## 3. 仕様（確定）
- 改行コード:
  - 通常テキスト行の改行としてそのまま扱う。
- 空行（改行コードのみの行）:
  - 表示改行としては扱わず、無視する。
- コメント:
  - `;` 以降、その行は完全に無視する（表示にも改行カウントにも入れない）。
- 新規タグ:
  - `[blankline]` を追加し、「空行を1つ挿入」を意味する。
- `文字列 + [blankline]` の挙動:
  - 直前に文字がある場合は、行を閉じてから空行を1つ挿入する。
  - 先頭または行頭で出現した場合は、空行を1つ挿入する。

## 4. 期待出力の例
- 入力:
```txt
あいうえお
[blankline]

[blankline]
かきくけこ
```
- 出力:
```txt
あいうえお


かきくけこ
```

## 5. 実装方針
1. `ParseScript()` の前処理を行単位で整理する。
2. コメント行の除去を「行ごと無視」に変更する。
3. 空行行は表示コマンドを追加せずスキップする。
4. `[blankline]` タグを `ParseTag()` に追加する。
5. `[blankline]` は内部的に改行コマンド列へ変換する。
6. 既存タグの処理順・挙動には影響を出さない。

## 6. 影響箇所
- `ParseScript()`:
  - 行処理ルール（通常行/空行/コメント行）を追加。
- `ParseTag()`:
  - `case "blankline"` を追加。
- `manual/class_tonmessage.html`:
  - 新タグ `[blankline]` の説明と利用例を追記。

### 6.1 マニュアル追記項目（改行コード・空行仕様）
- 追加見出し（案）: `改行と空行の扱い`
- 追記内容:
  - 改行コードは通常テキスト行の改行として扱うこと。
  - 空行（改行コードのみの行）は表示上の空行に使わず無視すること。
  - 表示上の空行は `[blankline]` を使って挿入すること。
  - `;` 以降はコメントとしてその行で完全に無視されること（表示にも改行カウントにも入れない）。
- 記載場所:
  - `manual/class_tonmessage.html` の `Script Format` 直下に専用説明として追加する。
- サンプル追記:
  - `文字列 + [blankline]` の例と、コメント行混在時の例を最小で1つずつ追加する。

## 7. 検証項目
- ケース1: 通常改行のみ
  - 既存と同じ表示になること。
- ケース2: 空行行のみ
  - 表示に改行が増えないこと。
- ケース3: `[blankline]` 単体
  - 空行1つが入ること。
- ケース4: `文字列[blankline]文字列`
  - 文字列間に空行1つが入ること。
- ケース5: コメント行
  - 表示されず、改行カウントにも影響しないこと。
- ケース6: `[blankline]` と `[next]` の併用
  - ページ送り挙動が崩れないこと。

## 8. 品質ゲート
- `dotnet build Mononotonka.csproj -v minimal` を実行し、0 warning / 0 error を確認する。

## 9. 受け入れ基準
- 仕様「3. 仕様（確定）」を全て満たしていること。
- 既存スクリプト資産で表示崩れ（改行過多/不足）が発生しないこと。
- manual の TonMessage タグ一覧に `[blankline]` が追加されていること。
- manual に「改行と空行の扱い」説明項目が追加されていること。
